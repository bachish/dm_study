Схема БД - группировака объектов вмеесте, логическое структурирование. Все это отражается на ФС, в  postgres отображается в блоки 8кб.

## Размещение коллекций 
Что влияет на выбор структуры хранения?
* Фрагментация памяти и локальность доступа
* Адресация и перемещаемость объектов
* Размещение по значениям или куча
* Своместное размещение нескольких коллекцпий

## Размещение данных на странице (в блоке)
Заголовок страницы  
Массив указателей на данные  
Область, доступная для размещения новых значений  
Область данных  
Дополнительная область  


* Данные не привязаны к месту внутри блока, поэтому адресация косвенная: при перемещении объекта перепиывается его адрес
* При вставке возможно уплотнение блока (vacuum в postgres)
* (в postgres) данные не записываются в одно и то же место - при update пишем новый объект, на какое-то время сохраняя старый (например, для транзакций полезно)
* для объектов переменной длинны храним его размер тоже в поле переменной длины, т.е. храним размер числа, в котором храним размер объекта

## Строки или колонки?
Зависит от класса задач. Были всякие системы.
1. Построчная 
2. Колоночная
3. Гибридная (пока в промышленномсти не популярна)

## Избыточные структуры хранения
т.е. при их удалении информация не утрачивается

Индексы
* Избыточны
* Абсолютно прозрачны для приложения (помотреть на его присутсвие при выполнении запроса мы не можем)
* Ускоряют выполнение некоторых запросов

Индексная запись: ключ, информация для объектов

Операции: поиск, удаление, вставка

Материализованные представления 
* Избыточны
* непрозрачны (видны в запросах, мб явно указаны)
* Ускоряют выполнение некоторых запросов
* Явно указываются в запросах


## B-деревья
Rudolf Baier 1972   
Динамическая структура: не деградирует при модификациях, не требует реорганизации

* Поиск по диапазону значений ключа: начиная с корня выбираем след. блок, где может быть нужное значение
* Особенно эффективны при небольшой доле выбираемых строк
* Поиск одного ключа: log_f_N  блоков
Основанине логарифма - количество записей в блоке, поэтому поиск быстр

## Хэширование 
* Не поддердивает поиск по диапазону
* Функция хеширования отображает пространство ключей в пространство адресов
* Обычно адреса соответствуют блокам файла, в котором размещен индекс
* Обработка записей переполнения
* Производительноcть зависит не от количества записей, а от заполненности файла

## Расширяемое хеширование
Как только блок переполняется - разделяем его на два, перераспределяем записи между ними равномерно и как только один из них переполняется  - расщепляем еще раз, но два указателя указываеют на один и тот же блок, который не был переоплнен.

Если расщепляем блок, который указывается больше одного раза - то удваивать таблицу уже не нужно.
Никаких цепочек переполнения и коллизий - все хорошо. Если данные размазываются неравномерно - то наоборот, оперативная память будет быстро перерастать.

## Индексы по нескольким атрибутам
* Составные индексы по нескольким атрибутам на основе лексикографического упорядочения (если первые неизвестны - поиск невозможен)
* Пространственные индексы (малые размерности)
* Пространства очень большой размерности
* Инвертированные индексы

## Пространственные индексы
* Запросы на точное значение или интервал по любому подмножеству атрибутов, включенных в индекс
* Запросы на близость к заданной точке
* Возможные подходы:
- Кривые, заполняющие пространство (Пеано, Z-order)
- Разбиение пространства
- Разбиение множества индексируемых объектов по близости (деревья)

## R-деревья
Поиск - это всегда прямоугольник, результат - прямоугольники, пересекающиеся с ним

В СУБД хранятся прямоугольники

Нужно, чтобы атрибуты были вещественными числами (время, координаты, давление, точки и т.д.)

* Поиск по нескольким ветвям
* Ошибки поиска: могут быть найдены нерелевантные объекты
* R+ - деревья: прямоугольники без пересечений, дробление объектов
* Процедура расщепления нетривиальна, качество зависит от вычислительной
сложности алгоритма
* Работает только для пространств малой размерности, хорошо работают от 4 до 15
* Быстро деградирует с увеличением размерности

## Инвертированные индексы
Индексируем объект его содержимым, используется для информационного поиска. 
Документ - список слов (термов), запись - список документов, содержащих это слово. Эти структуры симметричные, похожи на обратную функцию.

## Особенности реализации индексов в PostgreSQL
* Обобщенные индексные структуры (можно создавать свои индексы)
* GIST
* SP-GIST
* GIN
* BRIN